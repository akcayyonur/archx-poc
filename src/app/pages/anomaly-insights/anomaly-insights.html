<div class="page-container">
    <app-sidebar></app-sidebar>

    <div class="content-container">
        <header class="header-section">
            <div class="title-container">
                <ng-icon name="phosphorTrafficCone" style="font-size: 70px;"></ng-icon>
                <div class="title-text-container">
                    <h1>Operational Insights</h1>
                    <p>Analyze anomaly severity and view anomaly durations.</p>
                </div>
            </div>
            <div class="date-picker-shell">
                <div class="picker-field">
                  <label for="startDate">From</label>
                  <p-datepicker
                    inputId="startDate"
                    name="startDate"
                    [(ngModel)]="dateRange.start"
                    [ngModelOptions]="{ standalone: true }"
                    [showTime]="true"
                    hourFormat="24"
                    [showIcon]="false"
                    panelStyleClass="agent-date-panel"
                    dateFormat="dd.mm.yy"
                    placeholder="Select start">
                  </p-datepicker>
                </div>
                <div class="picker-field">
                  <label for="endDate">To</label>
                  <p-datepicker
                    inputId="endDate"
                    name="endDate"
                    [(ngModel)]="dateRange.end"
                    [ngModelOptions]="{ standalone: true }"
                    [showTime]="true"
                    hourFormat="24"
                    [showIcon]="false"
                    panelStyleClass="agent-date-panel"
                    dateFormat="dd.mm.yy"
                    placeholder="Select end">
                  </p-datepicker>
                </div>
              </div>
        </header>
        <main class="content-main">
            <!-- Top Section: Filter + Table -->
            <div class="top-section">
                <div class="filter-container">
                    <div class="filter-header">
                        <h2 class="filter-title">Filter</h2>
                        <p class="filter-subtitle">Show only selected severity levels</p>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-header">
                            <h3 class="filter-section-title">Severity levels</h3>
                            <p class="filter-section-subtitle">Select severity levels to hide/show</p>
                        </div>
                        
                        <div class="filter-buttons">
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSeverityLevels.includes('critical')"
                                (click)="toggleSeverityLevel('critical')">
                                Critical
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSeverityLevels.includes('high')"
                                (click)="toggleSeverityLevel('high')">
                                High
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSeverityLevels.includes('moderate')"
                                (click)="toggleSeverityLevel('moderate')">
                                Moderate
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3 class="filter-section-title">Special Filters</h3>
                        <div class="filter-buttons">
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSpecialFilters.includes('ongoing')"
                                (click)="toggleSpecialFilter('ongoing')">
                                ongoing
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSpecialFilters.includes('long-duration')"
                                (click)="toggleSpecialFilter('long-duration')">
                                long-duration
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedSpecialFilters.includes('recent')"
                                (click)="toggleSpecialFilter('recent')">
                                recent
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-section-header">
                            <h3 class="filter-section-title">Time Filters</h3>
                            <p class="filter-section-subtitle">Filter anomalies by time range</p>
                        </div>
                        
                        <div class="filter-buttons">
                            <button 
                                class="filter-button" 
                                [class.active]="selectedTimeFilters === '1h'"
                                (click)="toggleTimeFilter('1h')">
                                1h
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedTimeFilters === '4h'"
                                (click)="toggleTimeFilter('4h')">
                                4h
                            </button>
                            <button 
                                class="filter-button" 
                                [class.active]="selectedTimeFilters === '12h'"
                                (click)="toggleTimeFilter('12h')">
                                12h
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="anomalies-table">
                        <thead>
                            <tr>
                                <th (click)="toggleSort('anomaly')">
                                    <div class="th-content start">
                                        Anomaly
                                        <ng-icon name="phosphorSortAscending" *ngIf="sortColumn === 'anomaly' && sortDirection === 'asc'"></ng-icon>
                                        <ng-icon name="phosphorSortDescending" *ngIf="sortColumn === 'anomaly' && sortDirection === 'desc'"></ng-icon>
                                    </div>
                                </th>
                                <th (click)="toggleSort('entity')">
                                    <div class="th-content start">
                                        Entity
                                        <ng-icon name="phosphorSortAscending" *ngIf="sortColumn === 'entity' && sortDirection === 'asc'"></ng-icon>
                                        <ng-icon name="phosphorSortDescending" *ngIf="sortColumn === 'entity' && sortDirection === 'desc'"></ng-icon>
                                    </div>
                                </th>
                                <th (click)="toggleSort('status')">
                                    <div class="th-content center">
                                        Status
                                        <ng-icon name="phosphorSortAscending" *ngIf="sortColumn === 'status' && sortDirection === 'asc'"></ng-icon>
                                        <ng-icon name="phosphorSortDescending" *ngIf="sortColumn === 'status' && sortDirection === 'desc'"></ng-icon>
                                    </div>
                                </th>
                                <th (click)="toggleSort('severity')">
                                    <div class="th-content center">
                                        Severity
                                        <ng-icon name="phosphorSortAscending" *ngIf="sortColumn === 'severity' && sortDirection === 'asc'"></ng-icon>
                                        <ng-icon name="phosphorSortDescending" *ngIf="sortColumn === 'severity' && sortDirection === 'desc'"></ng-icon>
                                    </div>
                                </th>
                                <th (click)="toggleSort('timeRange')">
                                    <div class="th-content start">
                                        Time Range
                                        <ng-icon name="phosphorSortAscending" *ngIf="sortColumn === 'timeRange' && sortDirection === 'asc'"></ng-icon>
                                        <ng-icon name="phosphorSortDescending" *ngIf="sortColumn === 'timeRange' && sortDirection === 'desc'"></ng-icon>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let anomaly of paginatedAnomalies" 
                                [class.selected]="isAnomalySelected(anomaly)"
                                (contextmenu)="onRowRightClick($event, anomaly)">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px; padding-left: 16px;">
                                        <input type="checkbox" 
                                               class="anomaly-checkbox" 
                                               [checked]="isAnomalySelected(anomaly)"
                                               (change)="toggleAnomalySelection(anomaly)"
                                               (click)="$event.stopPropagation()" />
                                        <span class="clickable-text" (click)="navigateToAnomalyDetail(anomaly)" style="cursor: pointer;">{{ anomaly.anomaly }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="clickable-text" (click)="navigateToEntityInsights(anomaly)" style="cursor: pointer;">{{ anomaly.entity }}</span>
                                </td>
                                <td>{{ anomaly.status }}</td>
                                <td>
                                    <span class="severity-badge" [ngClass]="anomaly.severity.toLowerCase()">
                                        {{ anomaly.severity }}
                                    </span>
                                </td>
                                <td style="padding-left: 16px; width: 300px;">
                                    <div style="position: relative; width: 100%; height: 40px; display: flex; align-items: center; color: rgba(237, 234, 241, 0.65); font-size: 12px;">
                                        <!-- Full width background bar -->
                                        <div style="position: absolute; width: 100%; height: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px;"></div>
                                        
                                        <!-- Colored anomaly segment -->
                                        <div [ngStyle]="getAnomalyStyle(anomaly)" 
                                             [ngClass]="anomaly.severity.toLowerCase()"
                                             class="anomaly-bar-segment"
                                             style="position: relative; height: 8px; border-radius: 4px;">
                                            <span style="position: absolute; top: -20px; left: 0; transform: translateX(-50%); font-size: 10px; white-space: nowrap;">{{ formatTimeForDisplay(anomaly.timeRange.start) }}</span>
                                            <span style="position: absolute; bottom: -20px; right: 0; transform: translateX(50%); font-size: 10px; white-space: nowrap;">{{ formatTimeForDisplay(anomaly.timeRange.end) }}</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr *ngIf="paginatedAnomalies.length === 0" class="empty-state-row">
                                <td colspan="5">
                                    <div class="empty-state-content">
                                        <ng-icon name="phosphorInfo"></ng-icon>
                                        <p>No anomalies detected within the selected time range.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="pagination-controls" *ngIf="totalPages > 1">
                        <button class="page-btn prev-btn" 
                                [disabled]="currentPage === 1"
                                (click)="setPage(currentPage - 1)">
                            <ng-icon name="phosphorCaretLeft"></ng-icon>
                        </button>
                        <div class="page-numbers">
                            <button *ngFor="let page of pages" 
                                    class="page-num" 
                                    [class.active]="currentPage === page"
                                    (click)="setPage(page)">
                                {{ page }}
                            </button>
                        </div>
                        <button class="page-btn next-btn" 
                                [disabled]="currentPage === totalPages"
                                (click)="setPage(currentPage + 1)">
                            <ng-icon name="phosphorCaretRight"></ng-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Section: Full Width Charts -->
            <div class="anomalous-dimensions-container">
                <div class="anomalous-dimensions-header">
                    <div class="header-content">
                        <h3 class="anomalous-dimensions-title">Percentage of anomalous dimensions by type + anomaly_detection.type_anomaly_rate + [percentage]</h3>
                        <div class="header-actions-top">
                            <button class="icon-btn"><ng-icon name="phosphorInfo"></ng-icon></button>
                            <button class="icon-btn"><ng-icon name="phosphorPulse"></ng-icon></button>
                            <button class="icon-btn"><ng-icon name="phosphorCornersOut"></ng-icon></button>
                            <button class="icon-btn"><ng-icon name="phosphorCloudArrowDown"></ng-icon></button>
                        </div>
                    </div>
                </div>
                <div class="anomalous-dimensions-controls">
                    <div class="left-controls">
                        <div class="control-item">
                            <span>Group by Dimension</span>
                            <ng-icon name="phosphorCaretDown"></ng-icon>
                        </div>
                        
                        <div class="control-item">
                            <span>the SUM</span>
                            <ng-icon name="phosphorCaretDown"></ng-icon>
                        </div>

                        <div class="control-item">
                            <span>1 node</span>
                            <ng-icon name="phosphorCaretDown"></ng-icon>
                        </div>

                        <div class="control-item">
                            <span>1 instance</span>
                            <ng-icon name="phosphorCaretDown"></ng-icon>
                        </div>

                        <div class="control-item">
                            <span>47 dimensions</span>
                            <ng-icon name="phosphorCaretDown"></ng-icon>
                        </div>

                        <div class="control-text">2 labels</div>
                        <div class="control-text muted">each as AVG every 3s</div>

                        <button class="reset-pill">Reset</button>
                    </div>
                    <div class="time-range-controls">
                        @for (range of timeRanges; track range) {
                            <button 
                                class="time-range-btn" 
                                [class.active]="selectedTimeRange === range"
                                (click)="selectTimeRange(range)">
                                {{ range }}
                            </button>
                        }
                    </div>

                    <div class="right-chart-tools">
                         <button class="tool-btn"><ng-icon name="phosphorHandPalm"></ng-icon></button>
                         <button class="tool-btn"><ng-icon name="phosphorCrop"></ng-icon></button>
                         <button class="tool-btn"><ng-icon name="phosphorArrowsLeftRight"></ng-icon></button>
                         <button class="tool-btn"><ng-icon name="phosphorMagnifyingGlassPlus"></ng-icon></button>
                         <button class="tool-btn"><ng-icon name="phosphorMagnifyingGlassMinus"></ng-icon></button>
                         <button class="tool-btn"><ng-icon name="phosphorArrowCounterClockwise"></ng-icon></button>
                    </div>
                </div>
                <div class="anomalous-dimensions-content custom-chart-wrapper">
                     <div #anomalousDimensionsChart style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            <div class="service-tree-container">
                <div class="service-tree-header">
                    <h3 class="service-tree-title">Anomaly Impact Business Service Model</h3>
                </div>
                <div class="service-tree-content" #serviceModelChart></div>
            </div>

            <!-- Event Monitor Table -->
            <div class="event-monitor-container">
                <div class="event-monitor-header">
                    <h3>Anomaly Event Monitor</h3>
                </div>
                <div class="event-monitor-table-wrapper">
                    <table class="event-monitor-table">
                        <thead>
                            <tr>
                                <th>SEVERITY</th>
                                <th>AGE TIME</th>
                                <th>ANOMALY</th>
                                <th>TIME CREATED</th>
                                <th>TIME RECEIVED</th>
                                <th>ENTITY</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (anomaly of filteredAnomalies; track anomaly.id) {
                                <tr>
                                    <td class="severity-cell">
                                        <ng-icon 
                                            name="phosphorWarning" 
                                            [class]="'severity-icon severity-' + anomaly.severity.toLowerCase()">
                                        </ng-icon>
                                    </td>
                                    <td>{{ calculateAgeTime(anomaly) }}</td>
                                    <td class="anomaly-name">{{ anomaly.anomaly }}</td>
                                    <td>{{ formatDateTime(anomaly.timeRange.start) }}</td>
                                    <td>{{ formatDateTime(anomaly.timeRange.end) }}</td>
                                    <td>{{ anomaly.entity }}</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Context Menu -->
<app-anomaly-context-menu
    [visible]="contextMenuVisible"
    [position]="contextMenuPosition"
    [selectedAnomalies]="selectedAnomalies"
    (action)="onContextMenuAction($event)"
    (close)="closeContextMenu()">
</app-anomaly-context-menu>

<!-- Create Event Dialog -->
@if (eventDialogVisible) {
    <div class="event-dialog-overlay" (click)="closeEventDialog()">
        <div class="event-dialog" (click)="$event.stopPropagation()">
            <h2>Create Event</h2>
            
            <input 
                [(ngModel)]="eventForm.title" 
                placeholder="Title"
                class="event-input">
            
            <textarea 
                [(ngModel)]="eventForm.description" 
                placeholder="Description"
                class="event-textarea"
                rows="4"></textarea>
            
            <select [(ngModel)]="eventForm.severity" class="event-select">
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Moderate">Moderate</option>
            </select>
            
            <select [(ngModel)]="eventForm.category" class="event-select">
                <option value="Performance">Performance</option>
                <option value="Security">Security</option>
                <option value="Availability">Availability</option>
                <option value="Infrastructure">Infrastructure</option>
            </select>
            
            <select [(ngModel)]="eventForm.status" class="event-select">
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Resolved">Resolved</option>
            </select>
            
            <select [(ngModel)]="eventForm.assignedTeam" class="event-select">
                <option value="DevOps">DevOps</option>
                <option value="Platform">Platform</option>
                <option value="Security">Security</option>
                <option value="SRE">SRE</option>
            </select>
            
            <input 
                [(ngModel)]="eventForm.application" 
                placeholder="Application"
                class="event-input">
            
            <button (click)="saveEvent()" class="event-save-btn">Save</button>
        </div>
    </div>
}
